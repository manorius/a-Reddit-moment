<!DOCTYPE html>
<html>

  <head>

  <!-- Basic Page Needs
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Snoocore OAuth Explicit Authentication</title>

  <meta name="description" content="Snoocore - A minimal and complete JavaScript driver for the Reddit API">
  <meta name="author" content="Trevor Senior">
  <link rel="canonical" href="http://tsenior.com/snoocore/snoocore/oauth-explicit.html">

  <!-- Mobile Specific Metas
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- FONT
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="stylesheet" href='//fonts.googleapis.com/css?family=Raleway:400,300,600' type='text/css'>

  <!-- CSS
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="stylesheet" href="/snoocore/css/normalize.css">
  <link rel="stylesheet" href="/snoocore/css/skeleton.css">
  <link rel="stylesheet" href="/snoocore/css/custom-snoocore.css">

  <!-- Favicon
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <!-- <link rel="icon" type="image/png" href="dist/images/favicon.png"> -->

</head>


  <body>

    <div class="wrapper">
      <div class="sidebar"><ul>
  <li><a href="index.html">Home</a></li>

  <li><a href="features.html">Features</a></li>

  <li>Getting Started
    <ul>
      <li><a href="install.html">Install & Include</a></li>
      <li><a href="basicUsage.html">Basic Usage</a></li>
      <li><a href="config.html">Config Options</a></li>
      <li><a href="commonErrors.html">Common Errors</a></li>
    </ul>
  </li>

  <li><a href="login.html">Login</a>
    <ul>
      <li><a href="oauth.html">OAuth</a></li>
      <ul>
	<li><a href="oauth-script.html">Script</a></li>
	<li><a href="oauth-explicit.html">Explicit</a></li>
	<li><a href="oauth-implicit.html">Implicit</a></li>
      </ul>
  </li>
  <li><a href="cookies.html">Cookie</a></li>
    </ul>
  </li>

  <li>Helpers
    <ul>
      <li><a href="listings.html">Listings</a></li>
    </ul>
  </li>

  <li><a href="events.html">Events</a></li>
  <li><a href="fileUpload.html">File Upload</a></li>
  <li><a href="advancedUsage.html">Advanced Usage</a></li>

  <li>Resources
    <ul>
      <li><a href="migration.html">Migration Guide</a></li>
      <li><a href="tests.html">Running Tests</a></li>
      <li><a href="node-vs-browser.html">Node vs. Browser</a></li>
      <li><a href="promises.html">Promises</a></li>
    </ul>
  </li>

</ul>
</div>
      <div class="my-content"><h2 id="authenticating-with-explicit-oauth">Authenticating with Explicit OAuth</h2>

<p>See an example <a href="https://github.com/trevorsenior/snoocore-examples/blob/master/node/oauth-explicit.js">here</a>.</p>

<p>Unlike script-based apps, explicit apps can not authenticate using a username &amp; password. The main difference is that the program must wait for a user of the application to authenticate with reddit and get back an authorization code before moving on.</p>

<h2 id="supported-apps">Supported Apps</h2>

<p>Explicit based OAuth will only work if the app is a <code>web</code> or <code>installed</code> application.</p>

<h2 id="initial-config">Initial Config</h2>

<p>In the initial config, provide the OAuth settings for an application:</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">Snoocore</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;snoocore&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">reddit</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Snoocore</span><span class="p">({</span>
  <span class="nx">userAgent</span><span class="o">:</span> <span class="s1">&#39;your apps user agent&#39;</span><span class="p">,</span>
  <span class="nx">oauth</span><span class="o">:</span> <span class="p">{</span> 
    <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="c1">// required when using explicit OAuth</span>
    <span class="nx">mobile</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="c1">// defaults to false.</span>
    <span class="nx">duration</span><span class="o">:</span> <span class="s1">&#39;permanent&#39;</span><span class="p">,</span> <span class="c1">// defaults to &#39;temporary&#39;</span>
    <span class="nx">consumerKey</span><span class="o">:</span> <span class="s1">&#39;client_id from reddit&#39;</span><span class="p">,</span> 
    <span class="nx">consumerSecret</span><span class="o">:</span> <span class="s1">&#39;client_secret from reddit&#39;</span><span class="p">,</span> <span class="c1">// only needed if your app is type &#39;web&#39;</span>
    <span class="nx">redirectUri</span><span class="o">:</span> <span class="s1">&#39;redirectUri set for your app&#39;</span><span class="p">,</span>
    <span class="nx">scope</span><span class="o">:</span> <span class="p">[</span> <span class="s1">&#39;flair&#39;</span><span class="p">,</span> <span class="s1">&#39;identity&#39;</span> <span class="p">]</span> <span class="c1">// make sure to set all the scopes you need.</span>
  <span class="p">}</span>
<span class="p">});</span>  
</code></pre></div>
<h4 id="oauth.consumersecret"><code>oauth.consumerSecret</code></h4>

<p>This is only needed for web applications. Leave it an empty string, or leave it out all together for installed applications.</p>

<h4 id="oauth.mobile"><code>oauth.mobile</code></h4>

<p>Optional. Set mobile to true to send the user to the mobile reddit website for authentication.</p>

<h4 id="oauth.duration"><code>oauth.duration</code></h4>

<p>If the goal of the application is to do long term tasks (more than an hour) set this value to <code>&#39;permanent&#39;</code>.</p>

<p>Read the section on <a href="https://github.com/reddit/reddit/wiki/OAuth2#authorization">authorization</a> in the reddit OAuth documentation for more information.</p>

<h2 id="getting-the-authentication-url">Getting the authentication URL</h2>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="s1">&#39;foobar&#39;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">authUrl</span> <span class="o">=</span> <span class="nx">reddit</span><span class="p">.</span><span class="nx">getExplicitAuthUrl</span><span class="p">(</span><span class="nx">state</span><span class="p">);</span>
</code></pre></div>
<p>For CSRF prevention, set a <code>state</code>. This field is optional. Read more on this below.</p>

<h2 id="handling-the-response">Handling the response</h2>

<p>After the user visits the URL that <code>reddit.getExplicitAuthUrl</code> generates, they will be presented with the option to Allow or Deny the app. After they allow (or disallow) the application, reddit will redirect the user back to the given <code>redirectUri</code> (set in the initial config)  with the following url parameters:</p>

<ul>
<li><strong>error</strong> - something went wrong with the request</li>
<li><strong>code</strong> - the <code>authorizationCode</code> (used below)</li>
<li><strong>state</strong> - should be the same string that was set in the <code>reddit.getExplicitAuthUrl</code> function (if it was set).</li>
</ul>

<p>To handle this redirect from reddit, there needs to be something up and running (e.g. a server) at the <code>redirectUri</code> to intercept the above values and interpret them.</p>

<p>For CSRF prevention, check that the <code>state</code> in the url parameters is the same as the <code>state</code> specified when generating the authentication url in <code>reddit.getExplicitAuthUrl</code>.</p>

<h2 id="authenticating-with-the-returned-code">Authenticating with the returned code</h2>

<p>With the <code>authorizationCode</code> in the response from reddit, make one more call to get back authorization data:</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">AUTHORIZATION_CODE</span> <span class="o">=</span> <span class="s1">&#39;??&#39;</span><span class="p">;</span> <span class="cm">/* url parameter &quot;code&quot;, see above */</span>
<span class="kd">var</span> <span class="nx">RETURNED_STATE</span> <span class="o">=</span> <span class="s1">&#39;??&#39;</span><span class="p">;</span> <span class="cm">/* url parameter &quot;state&quot;, see above */</span>

<span class="c1">// Exit if the state given is invalid. This is an optional</span>
<span class="c1">// check, but is recommended if you set a state in </span>
<span class="c1">// `reddit.getExplicitAuthUrl`</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">RETURNED_STATE</span> <span class="o">!==</span> <span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;State is not the same as the one set!&#39;</span><span class="p">);</span>
  <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>                                                                
<span class="p">}</span>

<span class="c1">// Authenticate with reddit by passing in the authorization code from the response</span>
<span class="nx">reddit</span><span class="p">.</span><span class="nx">auth</span><span class="p">(</span><span class="nx">AUTHORIZATION_CODE</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">refreshToken</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// The refreshToken will be defined if in the initial</span>
  <span class="c1">// config `duration: &#39;permanent&#39;`</span>
  <span class="c1">// Otherwise if using a &#39;temporary&#39; duration it can be ignored.</span>

  <span class="c1">// Make an OAuth call to show that it is working</span>
  <span class="k">return</span> <span class="nx">reddit</span><span class="p">(</span><span class="s1">&#39;/api/v1/me&#39;</span><span class="p">).</span><span class="nx">get</span><span class="p">();</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span> <span class="c1">// Log the response</span>
<span class="p">});</span>
</code></pre></div>
<p>Snoocore is now successfully authenticated with OAuth.</p>

<h2 id="refresh-tokens-&amp;-re-authenticating">Refresh Tokens &amp; Re-Authenticating</h2>

<p>If the goal is to have a web/installed app that will run for more than an hour set <code>duration: &#39;permanent&#39;</code> in the oauth section of the initial config. This will allow Snoocore to automatically refresh the <code>access_token</code> when it expires after an hour of continuious use.</p>

<p>However, it is not persistant. When authenticating for the first time with <code>reddit.auth</code> (see previous section) it will provide a refreshToken. Save this token somewhere (database, etc.) for re-authentication at a later date.</p>

<p>Whenever you want to authenticate with that user in the future call:</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">reddit</span><span class="p">.</span><span class="nx">refresh</span><span class="p">(</span><span class="nx">SAVED_REFRESH_TOKEN</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// we are authenticated, make a call</span>
  <span class="k">return</span> <span class="nx">reddit</span><span class="p">(</span><span class="s1">&#39;/api/v1/me&#39;</span><span class="p">).</span><span class="nx">get</span><span class="p">();</span>
<span class="p">});</span>
</code></pre></div>
<p>There won&#39;t be a need to use the <code>reddit.auth</code> call to authenticate a user again unless they have revoked access to the application.</p>

<p>For an example with refresh token authentication take a look at these two scripts (run them in order):</p>

<ul>
<li><a href="https://github.com/trevorsenior/snoocore-examples/blob/master/node/oauth-web-permanent-1.js">oauth-web-permanent-1.js</a></li>
<li><a href="https://github.com/trevorsenior/snoocore-examples/blob/master/node/oauth-web-permanent-2.js">oauth-web-permanent-2.js</a></li>
</ul>

<h2 id="de-authenticating">De-Authenticating</h2>

<p>A function <code>reddit.deauth</code> is provided which will revoke the <code>access_token</code> for the current authenticated user.</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">deauthPromise</span> <span class="o">=</span> <span class="nx">reddit</span><span class="p">.</span><span class="nx">deauth</span><span class="p">();</span>
</code></pre></div>
<p>Generally it is a good idea to call this everytime the application is finished with the users data. To re-authenticate call <code>reddit.refresh</code> (see previous section).</p>

<p>To revoke the <code>refresh_token</code>, pass in the refreshToken in:</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">deauthPromise</span> <span class="o">=</span> <span class="nx">reddit</span><span class="p">.</span><span class="nx">deauth</span><span class="p">(</span><span class="nx">REFRESH_TOKEN</span><span class="p">);</span>
</code></pre></div>
<p>Note that this will revoke all <code>access_tokens</code> associated with this refreshToken. It will not be possible to use the refreshToken to get new access_tokens (e.g. re-authenticate with <code>reddit.refresh</code>).</p>

<h3 id="renewing-authentication-for-duration:-&#39;temporary&#39;">Renewing authentication for <code>duration: &#39;temporary&#39;</code></h3>

<p>If the app does not use <code>duration: &quot;permanent&quot;</code> then it will not have a refresh token available when authenticating. It is possible to listen for an event and have the user re-authenticate with the application. For more information on this view the <a href="events.html">Snoocore Events</a> documentation.</p>
</div>
    </div>

  </body>
</html>
